<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Testar Convers√£o ‚Äî LabelConvert</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    body {
      background: linear-gradient(135deg, #fff8f2, #fff);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: "Poppins", sans-serif;
    }

    .upload-card {
      background: #fff;
      border-radius: 14px;
      padding: 40px 50px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 420px;
      transition: transform 0.3s ease;
      overflow-y: auto;
      max-height: 95vh;
    }

    .upload-card:hover {
      transform: translateY(-4px);
    }

    h2 {
      color: #ff6b00;
      margin-bottom: 10px;
      font-size: 1.8rem;
    }

    p {
      color: #666;
      margin-bottom: 25px;
      font-size: 0.95rem;
    }

    input[type="file"] {
      display: block;
      width: 100%;
      margin: 12px 0;
      padding: 10px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      cursor: pointer;
      transition: border 0.3s;
    }

    input[type="file"]:hover {
      border-color: #ff6b00;
    }

    button {
      background: #ff6b00;
      color: white;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 8px;
      width: 100%;
      font-weight: 600;
      transition: background 0.3s;
    }

    button:hover {
      background: #e65c00;
    }

    #status {
      margin-top: 20px;
      font-size: 15px;
      color: #444;
      font-weight: 500;
    }

    .back-link {
      margin-top: 25px;
      display: inline-block;
      color: #ff6b00;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    #preview {
      display: block;
      margin: 10px auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 400px;
      height: 600px;
      object-fit: contain;
      background: #f8f8f8;
    }

    .small-btn {
      width: 100%;
      display: block;
      margin-bottom: 8px;
      padding: 8px 16px;
      border-radius: 5px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    hr {
      margin: 30px 0;
      border: none;
      border-top: 2px dashed #ddd;
    }
	
	::-webkit-scrollbar {
	  width: 10px;
	}

	::-webkit-scrollbar-track {
	  background: #fff2e6; /* fundo clarinho */
	  border-radius: 10px;
	}

	::-webkit-scrollbar-thumb {
	  background-color: #ff6b00; /* cor da marca */
	  border-radius: 10px;
	  border: 2px solid #fff2e6; /* contorno suave */
	}

	::-webkit-scrollbar-thumb:hover {
	  background-color: #e65c00; /* tom mais escuro ao passar o mouse */
	}

	/* Firefox */
	* {
	  scrollbar-width: thin;
	  scrollbar-color: #ff6b00 #fff2e6;
	}
  </style>
</head>

<body>
  <div class="upload-card">
    <!-- üü† SE√á√ÉO 1 - Gera√ß√£o de etiquetas -->
    <section id="sectionConvertPDF">
      <h2>Conversor de Etiquetas</h2>
      <p>Envie seu PDF e planilha Excel (.xlsx) para gerar as etiquetas automaticamente.</p>

      <form id="uploadForm">
        <input type="file" name="pdf" accept="application/pdf" required />
        <input type="file" name="xlsx" accept=".xlsx" required />
        <button type="submit">Converter e Baixar</button>
      </form>

      <p id="status"></p>
    </section>

    <hr />

    <!-- üü¢ SE√á√ÉO 2 - Convers√£o para ZPL -->
    <section id="sectionZPL">
      <h2>Converter etiquetas para ZPL</h2>
      <input type="file" id="file" />
      <button id="btn">Converter para ZPL</button>

      <div id="result" style="margin-top:20px;display:none;">
        <h3>Pr√©via da primeira etiqueta:</h3>
        <div id="zplBox" style="background:#1e1e1e;color:#ff6b00;font-family:monospace;padding:10px;height:200px;overflow:auto;white-space:pre;border-radius:8px;"></div>

        <div style="margin-top:10px;">
          <button id="copyBtn" class="small-btn" style="background:#ff7b00;color:#fff;">üìã Copiar c√≥digo</button>
          <button id="downloadAll" class="small-btn" style="background:#00b341;color:#fff;">üíæ Baixar todas</button>
        </div>

        <h4 style="margin-top:20px;">Preview gerado:</h4>
        <img id="preview" alt="Preview da etiqueta" />
      </div>
    </section>

    <a href="/" class="back-link">‚Üê Voltar ao in√≠cio</a>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const status = document.getElementById("status");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      status.textContent = "‚è≥ Gerando etiquetas, aguarde...";

      try {
        const response = await fetch("/upload", { method: "POST", body: formData });
        if (!response.ok) throw new Error("Erro ao processar.");

        const blob = await response.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "etiquetas_final.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        status.textContent = "‚úÖ Arquivo gerado com sucesso!";
      } catch (err) {
        status.textContent = "‚ùå Erro ao gerar etiquetas.";
        console.error(err);
      }
    });

    // ======================
    // üî∏ GERAR ZPL E PREVIEW
    // ======================
    document.getElementById('btn').onclick = async () => {
      const btn = document.getElementById('btn');
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];
      if (!file) return alert('Selecione um arquivo PDF primeiro!');

      btn.disabled = true;
      const originalBtnText = btn.textContent;
      btn.textContent = '‚è≥ Convertendo...';
      btn.style.background = '#999';

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/generate_zpl_image/', { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`Erro no backend (${res.status})`);
        const data = await res.json();

        const zpls = data.zpl;
        if (!zpls || !zpls.length) throw new Error('Nenhum ZPL retornado!');

        const firstZPL = zpls[0];
        const zplBox = document.getElementById('zplBox');
        const preview = document.getElementById('preview');
        const resultDiv = document.getElementById('result');

        resultDiv.style.display = 'block';
        zplBox.textContent = firstZPL.slice(0, 2000) + (firstZPL.length > 2000 ? '\n...\n(c√≥digo truncado)' : '');

        // Bot√£o de copiar com feedback visual
        const copyBtn = document.getElementById('copyBtn');
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(firstZPL);
          copyBtn.textContent = '‚úÖ C√≥digo copiado!';
          copyBtn.style.background = '#00b341';
          setTimeout(() => {
            copyBtn.textContent = 'üìã Copiar c√≥digo';
            copyBtn.style.background = '#ff7b00';
          }, 2000);
        };

        // Baixar todas (concat)
        const downloadAllBtn = document.getElementById('downloadAll');
        downloadAllBtn.onclick = () => {
          const blob = new Blob([zpls.join("\n")], { type: 'text/plain' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'etiquetas_todas.zpl';
          link.click();
        };

        // Preview da primeira etiqueta (gerado pelo backend)
        try {
          const previewForm = new FormData();
          previewForm.append('file', file);
          const previewResponse = await fetch('/preview_zpl/', { method: 'POST', body: previewForm });
          if (!previewResponse.ok) throw new Error("Erro ao gerar preview no servidor.");
          const blob = await previewResponse.blob();
          const blobUrl = URL.createObjectURL(blob);
          preview.onload = () => URL.revokeObjectURL(blobUrl);
          preview.src = blobUrl;
          preview.style.display = 'block';
        } catch (err) {
          console.error("Erro ao gerar preview:", err);
          preview.src = "";
        }

      } catch (err) {
        console.error(err);
        alert('Erro durante a convers√£o ‚Äî veja o console para detalhes.');
      } finally {
        btn.disabled = false;
        btn.textContent = originalBtnText;
        btn.style.background = '';
      }
    };
  </script>
</body>
</html>
